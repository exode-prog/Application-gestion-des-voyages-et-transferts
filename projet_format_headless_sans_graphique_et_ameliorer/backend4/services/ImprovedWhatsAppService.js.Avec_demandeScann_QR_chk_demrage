// =====================================================
// SERVICE WHATSAPP - VERSION FORCE NEW SESSION
// =====================================================

const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const fs = require('fs');
const path = require('path');

class ImprovedWhatsAppService {
  constructor() {
    this.client = null;
    this.isReady = false;
    this.qrCodeGenerated = false;
    
    // FORCER une nouvelle session √† chaque fois
    this.sessionPath = this.createNewSessionPath();
    this.clientId = this.generateClientId();
    
    console.log('üÜï NOUVELLE SESSION FORC√âE');
    console.log('üì± ID Client:', this.clientId);
    console.log('üìÅ Dossier session:', this.sessionPath);
    
    this.initializeClient();
  }

  // Cr√©er un NOUVEAU chemin de session √† chaque fois
  createNewSessionPath() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 10);
    const newPath = path.join(__dirname, `../.whatsapp_session_${timestamp}_${random}`);
    
    // Supprimer s'il existe d√©j√†
    if (fs.existsSync(newPath)) {
      fs.rmSync(newPath, { recursive: true, force: true });
    }
    
    return newPath;
  }

  // G√©n√©rer un ID client unique
  generateClientId() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 15);
    return `force-new-session-${timestamp}-${random}`;
  }

  initializeClient() {
    console.log('üîÑ INITIALISATION WHATSAPP - FORCAGE NOUVELLE SESSION');
    
    // Configuration avec session FORC√âE
    this.client = new Client({
      authStrategy: new LocalAuth({
        dataPath: this.sessionPath,
        clientId: this.clientId
      }),
      puppeteer: {
        executablePath: '/usr/bin/chromium-browser',
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-accelerated-2d-canvas',
          '--no-first-run',
          '--no-zygote',
          '--disable-gpu',
          '--disable-software-rasterizer',
          '--disable-background-timer-throttling',
          '--disable-backgrounding-occluded-windows',
          '--disable-renderer-backgrounding',
          '--disable-features=Translate,BackForwardCache',
          '--disable-ipc-flooding-protection',
          '--no-default-browser-check',
          '--disable-default-apps',
          '--disable-sync',
          '--no-experiments',
          '--disable-translate',
          '--disable-extensions',
          '--disable-component-extensions-with-background-pages',
          '--disable-component-update',
          '--disable-breakpad',
          '--disable-crash-reporter',
          '--disable-back-forward-cache',
          '--disable-domain-reliability',
          '--disable-print-preview',
          '--remote-debugging-port=0',
          '--user-data-dir=/tmp/chrome-temp-' + Date.now()  // FORCER nouveau profil
        ],
        env: {
          ...process.env,
          DISPLAY: ':99'
        }
      }
    });

    // QR Code - TOUJOURS affich√©
    this.client.on('qr', (qr) => {
      console.log('\nüîê üîê üîê NOUVEAU QR CODE OBLIGATOIRE üîê üîê üîê');
      console.log('==============================================');
      console.log('üì± OUVREZ WHATSAPP > MENU > APPAREILS CONNECT√âS');
      console.log('üì± PUIS > CONNECTER UN APPAREIL');
      console.log('üÜï SCANNEZ CE QR CODE POUR NOUVELLE SESSION');
      console.log('==============================================');
      qrcode.generate(qr, { small: true });
      console.log('==============================================');
      console.log('‚è∞ QR Code valable 60 secondes');
      console.log('üí° Fermez WhatsApp sur votre t√©l√©phone et rouvrez-le si besoin');
      
      this.qrCodeGenerated = true;
    });

    // Authentification r√©ussie
    this.client.on('authenticated', () => {
      console.log('‚úÖ Authentification r√©ussie avec nouvelle session');
      console.log('üì± ID Session:', this.clientId);
    });

    // Client pr√™t
    this.client.on('ready', () => {
      console.log('üöÄ WHATSAPP PR√äT - Nouvelle session active');
      this.isReady = true;
    });

    // √âchec authentification
    this.client.on('auth_failure', (msg) => {
      console.error('‚ùå √âchec auth:', msg);
      this.isReady = false;
    });

    // D√©connexion
    this.client.on('disconnected', (reason) => {
      console.log('üîå D√©connect√©:', reason);
      this.isReady = false;
    });

    // Chargement
    this.client.on('loading_screen', (percent, message) => {
      console.log(`üì± Chargement: ${percent}% - ${message}`);
    });

    // Initialiser
    console.log('üéØ D√©marrage du client WhatsApp...');
    this.client.initialize().catch(err => {
      console.error('‚ùå Erreur init:', err);
    });
  }

  // Fonction pour forcer manuellement un nouveau QR
  async forceQRCode() {
    console.log('üîÑ DEMANDE MANUELLE DE NOUVEAU QR CODE');
    
    if (this.client) {
      await this.client.destroy();
      console.log('‚úÖ Ancienne session d√©truite');
    }
    
    // Attendre un peu
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Recr√©er avec nouveau ID
    this.clientId = this.generateClientId();
    this.sessionPath = this.createNewSessionPath();
    this.isReady = false;
    this.qrCodeGenerated = false;
    
    console.log('üÜï NOUVEAU ID:', this.clientId);
    this.initializeClient();
    
    return { success: true, message: 'Nouveau QR code demand√©' };
  }

  // V√©rifier statut
  getStatus() {
    return {
      isReady: this.isReady,
      qrCodeGenerated: this.qrCodeGenerated,
      clientId: this.clientId,
      sessionPath: this.sessionPath
    };
  }

  // Fonction pour formater le num√©ro de t√©l√©phone
  formatPhoneNumber(phone) {
    let cleaned = phone.replace(/[^0-9+]/g, '');
    if (cleaned.startsWith('+')) {
      cleaned = cleaned.substring(1);
    }
    return `${cleaned}@c.us`;
  }

  // V√©rifier si le client est pr√™t
  async waitForReady(timeout = 60000) {
    const startTime = Date.now();
    while (!this.isReady) {
      if (Date.now() - startTime > timeout) {
        throw new Error('Timeout: Client WhatsApp non pr√™t');
      }
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    return true;
  }

  // Envoyer un message
  async sendMessage(phoneNumber, message) {
    try {
      console.log('\nüì§ Envoi message...');
      await this.waitForReady();

      const chatId = this.formatPhoneNumber(phoneNumber);
      console.log('üìû Num√©ro:', chatId);

      const isRegistered = await this.client.isRegisteredUser(chatId);
      if (!isRegistered) {
        return {
          success: false,
          error: 'Num√©ro non enregistr√© sur WhatsApp'
        };
      }

      const sentMessage = await this.client.sendMessage(chatId, message);
      console.log('‚úÖ Message envoy√©');

      return {
        success: true,
        messageId: sentMessage.id._serialized,
        timestamp: sentMessage.timestamp
      };

    } catch (error) {
      console.error('‚ùå Erreur:', error.message);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // Envoyer un message de confirmation de voyage
  async sendTravelConfirmation(clientData) {
    const paysFormatted = Array.isArray(clientData.pays) 
      ? clientData.pays.join(', ') 
      : clientData.pays;

    const message = `Bonjour *${clientData.prenom} ${clientData.nom}*,

Nous avons bien re√ßu vos *documents de voyage* pour *${paysFormatted}*.

Notre √©quipe examine actuellement votre dossier.

Vous serez recontact√©(e) sous *48h maximum*.

Merci de votre confiance ! 

_DataCollectApp - Soumission de documents en ligne_`;

    return await this.sendMessage(clientData.telephone, message);
  }

  // Envoyer un message de confirmation de transfert
  async sendTransferConfirmation(clientData) {
    const entrepriseLine = clientData.entreprise && clientData.entreprise.trim() !== '' 
      ? `*Entreprise:* _${clientData.entreprise}_\n` 
      : '';

    const message = `Bonjour *${clientData.prenom} ${clientData.nom}*,

Nous avons bien re√ßu votre *dossier de transfert* :
_${clientData.typeTransfert}_
${entrepriseLine}
Notre √©quipe examine actuellement votre demande.

Vous serez recontact√©(e) sous *48h maximum*.

Merci de votre confiance ! 

_DataCollectApp - Soumission de documents en ligne_`;

    return await this.sendMessage(clientData.telephone, message);
  }

  // Fonction automatique
  async sendAutoNotification(formData, type) {
    console.log('\nü§ñ ENVOI AUTO WHATSAPP -', type);
    try {
      let result;
      if (type === 'voyage') {
        result = await this.sendTravelConfirmation(formData);
      } else {
        result = await this.sendTransferConfirmation(formData);
      }
      return result;
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }
}

module.exports = new ImprovedWhatsAppService();
